machine:
  environment:
    SCRATCH: "$HOME/scratch"
    DS003_URL: "https://files.osf.io/v1/resources/fvuh8/providers/osfstorage/57f328f6b83f6901ef94cf70"
  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"
    - "~/data"
    - "~/.cache/stanford-crn"

  pre:
    # Download test data
    - mkdir -p ~/data/ ~/docker
    # Create scratch folder and force group permissions
    - mkdir -p $SCRATCH && sudo setfacl -d -m group:ubuntu:rwx $SCRATCH && sudo setfacl -m group:ubuntu:rwx $SCRATCH
    - if [[ ! -d ~/data/ds003_downsampled ]]; then wget --retry-connrefused --waitretry=5 --read-timeout=20 --timeout=15 -t 0 -q -O ds003_downsampled.tar.gz "${DS003_URL}" && tar xzf ds003_downsampled.tar.gz -C ~/data/; fi
    - pip install "niworkflows>=0.0.3a15"
  override:
    - python -c "from niworkflows import data as nwd; nwd.get_mni_icbm152_nlin_asym_09c(); nwd.get_ds003_downsampled(); nwd.get_brainweb_1mm_normal()"
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
    - docker build -f docker/Dockerfile_py35 -t mriqc:py35 .
    - docker build -f docker/Dockerfile_py27 -t mriqc:py27 .
    - docker save mriqc:py35 > ~/docker/image.tar

test:
  override:
    # Test mriqcp
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/.cache/stanford-crn:/root/.cache/stanford-crn -v ${CIRCLE_TEST_REPORTS}:/scratch -w /root/src/mriqc --entrypoint="/usr/bin/run_tests" mriqc:py35 :
        timeout: 2600
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/.cache/stanford-crn:/root/.cache/stanford-crn -v ~/data:/data:ro -v $SCRATCH/func:/scratch -w /scratch mriqc:py35 /data/ds003_downsampled out/ participant -d func -w work/ --n_procs 12 --testing --verbose-reports :
        timeout: 2600
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/data:/data:ro -v $SCRATCH/func:/scratch -w /scratch mriqc:py35 /data/ds003_downsampled out/ group -d func -w work/
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/.cache/stanford-crn:/root/.cache/stanford-crn -v ~/data:/data:ro -v $SCRATCH/anat:/scratch -w /scratch mriqc:py35 /data/ds003_downsampled out/ participant -d anat -w work/ --testing --verbose-reports :
        timeout: 2600
    - docker run -i -v /etc/localtime:/etc/localtime:ro -v ~/data:/data:ro -v $SCRATCH/anat:/scratch -w /scratch mriqc:py27 /data/ds003_downsampled out/ group -d anat -w work/

general:
  artifacts:
    - "~/scratch"
  branches:
    ignore:
      - gh-pages # ignore gh-pages

# deployment:
#   codecov:
#     branch: /.*/
#     commands:
#       - bash <(curl -s https://codecov.io/bash)
